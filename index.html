<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Рецепты</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Рецепты</h1>

  <section id="recipeFormSection">
    <h2 id="formTitle">Добавить рецепт</h2>
    <form id="recipeForm">
      <div>
        <label for="recipeTitle">Название рецепта:</label><br>
        <input type="text" id="recipeTitle" name="recipeTitle" required>
      </div>
      <div>
        <label for="recipeStatus">Статус рецепта:</label><br>
        <select id="recipeStatus" name="recipeStatus">
          <option value="tasty">Вкусно</option>
          <option value="not-so-good">Не очень</option>
          <option value="not-tried">Не пробовал</option>
        </select>
      </div>
      <div id="ingredientsContainer">
        <h3>Ингредиенты</h3>
        <div id="ingredientsList"></div>
        <button type="button" id="addIngredientBtn">Добавить ингредиент</button>
      </div>
      <div>
        <label for="instructions">Инструкция:</label><br>
        <textarea id="instructions" name="instructions" rows="5" cols="50" required></textarea>
      </div>
      <div>
        <button type="submit" id="submitBtn">Сохранить рецепт</button>
        <button type="button" id="cancelEditBtn" style="display:none;">Отмена редактирования</button>
      </div>
    </form>
  </section>

  <section id="recipesSection">
    <h2>Сохраненные рецепты</h2>
    <div id="recipesList"></div>
  </section>

  <script>
    // JQuery 4o-mini
    const $ = function (el) {
      if (el.startsWith('#')) {
        return document.getElementById(el.slice(1));
      } else if (el.startsWith('.')) {
        return document.getElementsByClassName(el.slice(1));
      } else {
        return document.createElement(el);
      }
    }

    let editingIndex = null; // Хранит индекс редактируемого рецепта

    // Функция для создания новой строки ингредиента
    function createIngredientRow(name = '', status = 'required') {
      const div = $('div');
      div.classList.add('ingredient');
      if (status === 'optional') {
        div.classList.add('optional');
      } else if (status === 'interchangeable') {
        div.classList.add('interchangeable');
      }
      
      const input = $('input');
      input.type = 'text';
      input.placeholder = 'Название ингредиента';
      input.value = name;
      input.required = true;
      
      const select = $('select');
      const options = [
        { value: 'required', text: 'Обязательный' },
        { value: 'optional', text: 'Опциональный' },
        { value: 'interchangeable', text: 'Взаимозаменяемый' }
      ];
      options.forEach(opt => {
        const option = $('option');
        option.value = opt.value;
        option.textContent = opt.text;
        if (opt.value === status) {
          option.selected = true;
        }
        select.appendChild(option);
      });
      
      // При смене статуса обновляем класс для визуального отображения
      select.addEventListener('change', function() {
        div.classList.remove('optional', 'interchangeable');
        if (select.value === 'optional') {
          div.classList.add('optional');
        } else if (select.value === 'interchangeable') {
          div.classList.add('interchangeable');
        }
      });
      
      const removeBtn = $('button');
      removeBtn.type = 'button';
      removeBtn.textContent = 'Удалить';
      removeBtn.classList.add('remove-ingredient');
      removeBtn.addEventListener('click', function() {
        div.remove();
      });
      
      div.appendChild(input);
      div.appendChild(select);
      div.appendChild(removeBtn);
      
      return div;
    }
    
    // Добавляем первую строку ингредиента при загрузке
    const ingredientsList = $('#ingredientsList');
    ingredientsList.appendChild(createIngredientRow());
    
    // Обработчик кнопки "Добавить ингредиент"
    $('#addIngredientBtn').addEventListener('click', function() {
      ingredientsList.appendChild(createIngredientRow());
    });
    
    // Функция для получения рецептов из localStorage
    function loadRecipes() {
      const recipes = localStorage.getItem('recipes');
      return recipes ? JSON.parse(recipes) : [];
    }
    
    // Функция для сохранения рецептов в localStorage
    function saveRecipes(recipes) {
      localStorage.setItem('recipes', JSON.stringify(recipes));
    }
    
    // Функция для отображения сохраненных рецептов
    function renderRecipes() {
      const recipesList = $('#recipesList');
      recipesList.innerHTML = '';
      const recipes = loadRecipes();
      
      // Маппинг для статуса рецепта: текст и класс для оформления
      const statusMapping = {
        'tasty': { text: 'Вкусно', class: 'status-tasty' },
        'not-so-good': { text: 'Не очень', class: 'status-not-so-good' },
        'not-tried': { text: 'Не пробовал', class: 'status-not-tried' }
      };
      const ingStatusMapping = {
        'required': { text: 'Обязательный' },
        'optional': { text: 'Опциональный' },
        'interchangeable': { text: 'Взаимозаменяемый' }
      };
      
      recipes.forEach((recipe, index) => {
        const div = $('div');
        div.classList.add('recipe');
        
        if (recipe.status) {
          const mapping = statusMapping[recipe.status] || {};
          const statusSpan = $('span');
          statusSpan.textContent = mapping.text || recipe.status;
          if (mapping.class) {
            statusSpan.classList.add(mapping.class);
          }
          div.appendChild(statusSpan);
        }
        
        const editBtn = $('button');
        editBtn.type = 'button';
        editBtn.textContent = 'Редактировать';
        editBtn.classList.add('edit-button');
        editBtn.addEventListener('click', function() {
          editRecipe(index);
        });
        div.appendChild(editBtn);
        
        const title = $('h3');
        title.textContent = recipe.title;
        div.appendChild(title);
        
        const ingList = $('ul');
        recipe.ingredients.forEach(ing => {
          const mapping = ingStatusMapping[ing.status] || {};
          const li = $('li');
          li.textContent = ing.name + ' (' + (mapping.text || ing.status) + ')';
          ingList.appendChild(li);
        });
        div.appendChild(ingList);
        
        const instr = $('div');
        instr.classList.add('instructions');
        instr.textContent = recipe.instructions;
        div.appendChild(instr);
        
        recipesList.appendChild(div);
      });
    }
    
    // Функция для загрузки рецепта в форму редактирования
    function editRecipe(index) {
      const recipes = loadRecipes();
      const recipe = recipes[index];
      
      $('#recipeTitle').value = recipe.title;
      $('#instructions').value = recipe.instructions;
      $('#recipeStatus').value = recipe.status || 'tasty';
      
      // Очищаем список ингредиентов и загружаем ингредиенты рецепта
      ingredientsList.innerHTML = '';
      recipe.ingredients.forEach(ing => {
        ingredientsList.appendChild(createIngredientRow(ing.name, ing.status));
      });
      
      editingIndex = index;
      
      $('#formTitle').textContent = 'Редактировать рецепт';
      $('#submitBtn').textContent = 'Обновить рецепт';
      $('#cancelEditBtn').style.display = 'inline-block';
      
      // Прокрутка к форме
      window.scrollTo(0, 0);
    }
    
    // Отмена редактирования
    $('#cancelEditBtn').addEventListener('click', function() {
      editingIndex = null;
      $('#recipeForm').reset();
      ingredientsList.innerHTML = '';
      ingredientsList.appendChild(createIngredientRow());
      $('#formTitle').textContent = 'Добавить рецепт';
      $('#submitBtn').textContent = 'Сохранить рецепт';
      $('#cancelEditBtn').style.display = 'none';
    });
    
    // Обработчик отправки формы – сохранение или обновление рецепта
    $('#recipeForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const title = $('#recipeTitle').value.trim();
      const instructions = $('#instructions').value.trim();
      const recipeStatus = $('#recipeStatus').value;
      
      // Собираем ингредиенты
      const ingredientDivs = document.querySelectorAll('#ingredientsList .ingredient');
      const ingredients = [];
      ingredientDivs.forEach(div => {
        const name = div.querySelector('input[type="text"]').value.trim();
        const status = div.querySelector('select').value;
        if (name !== '') {
          ingredients.push({ name, status });
        }
      });
      
      if (title === '' || instructions === '' || ingredients.length === 0) {
        alert('Пожалуйста, заполните все поля и добавьте хотя бы один ингредиент.');
        return;
      }
      
      const recipes = loadRecipes();
      if (editingIndex !== null) {
        // Обновление существующего рецепта
        recipes[editingIndex] = { title, status: recipeStatus, ingredients, instructions };
        editingIndex = null;
      } else {
        // Добавление нового рецепта
        recipes.push({ title, status: recipeStatus, ingredients, instructions });
      }
      
      saveRecipes(recipes);
      
      $('#recipeForm').reset();
      ingredientsList.innerHTML = '';
      ingredientsList.appendChild(createIngredientRow());
      $('#formTitle').textContent = 'Добавить рецепт';
      $('#submitBtn').textContent = 'Сохранить рецепт';
      $('#cancelEditBtn').style.display = 'none';
      
      renderRecipes();
    });
    
    // Первоначальное отображение рецептов
    renderRecipes();
  </script>
</body>
</html>
